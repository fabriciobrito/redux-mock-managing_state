<!DOCTYPE html>
<html>
  <head>
    <title>
      Udacity Lesson 2 - ToDo's and Goals
    </title>
    <!-- Import Redux -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js'></script>
    <!-- Import React, ReactDom and Babel (to handle JSX transpile)-->
    <script src='https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js'></script>
    <script src='https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js'></script>
    <script src='https://unpkg.com/babel-standalone@6.15.0/babel.min.js'></script>
  </head>
  <body>
    <div>
      <h1>ToDo's List</h1>
      <input id="todo" type="text" placeholder="Add ToDo" />
      <button id="todoButton">Add ToDo</button>
      <ul id="todos"></ul>
    </div>
    <h1>Goals List</h1>
      <input id="goal" type="text" placeholder="Add Goal" />
      <button id="goalButton">Add Goal</button>
      <ul id="goals"></ul>
    </div>
    <!-- Divide plain HTML from Reac Components here -->
    <hr />
    <div id="app"></div>
    <script type="text/javascript">
      //Random ID Generator for testing purposes
      function generateId () {
        return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
      }

      //App Code
      //Actions List
      const ADD_TODO = 'ADD_TODO';
      const REMOVE_TODO = 'REMOVE_TODO';
      const TOGGLE_TODO = 'TOGGLE_TODO';
      const ADD_GOAL = 'ADD_GOAL';
      const REMOVE_GOAL = 'REMOVE_GOAL';

      //Action Functions
      function addToDoAction(todo) {
        return {
          type: ADD_TODO,
          todo
        }
      };

      function removeToDoAction(id) {
        return {
          type: REMOVE_TODO,
          id
        }
      };

      function toggleToDoAction(id) {
        return {
          type: TOGGLE_TODO,
          id
        }
      };

      function addGoalAction(goal) {
        return {
          type: ADD_GOAL,
          goal
        }
      };

      function removeGoalAction(id) {
        return {
          type: REMOVE_GOAL,
          id
        }
      };

      // ToDo's Reducer (Pure Function)
      function todos (state = [], action) {
        switch (action.type) {
          case ADD_TODO:
            return state.concat([action.todo]);
          case REMOVE_TODO:
            return state.filter((todo) => todo.id !== action.id);
          case TOGGLE_TODO:
            return state.map((todo) => todo.id !== action.id? todo :
              Object.assign({}, todo, {complete: !todo.complete})
            )
          default:
            return state;
        }
      }

      // Goals Reducer (Pure Function)
      function goals (state = [], action) {
        switch(action.type) {
          case ADD_GOAL:
            return state.concat([action.goal]);
          case REMOVE_GOAL:
            return state.filter(goal => goal.id !== action.id);
          default:
            return state;
        }
      }

      // What a nightmare this Redux Middleware structure can be, huh?
      // This is needed to allow middleware serialization with the next function
      const checker = (store) => (next) => (action) => {
        if (
          (action.type === ADD_TODO &&
          action.todo.name.toLowerCase().includes('bitcoin'))
          ||
          (action.type === ADD_GOAL &&
          action.goal.name.toLowerCase().includes('bitcoin'))
        )
          return alert('Nope. That\'s a bad idea. Try something else...')
        return next(action);
      }

      // Logger Middleware for debugging purposes
      const logger = (store) => (next) => (action) => {
        console.group(action.type);
          console.log('The action: ', action);
          const result = next(action);
          console.log('The new state: ', store.getState());
        console.groupEnd()
        return result;
      }

      const store = Redux.createStore(Redux.combineReducers({
        todos,
        goals
      }), Redux.applyMiddleware(checker, logger));

      store.subscribe(() => {
        const {todos, goals} = store.getState();

        document.getElementById('todos').innerHTML = '';
        document.getElementById('goals').innerHTML = '';

        todos.forEach(todo => addToDoToDom(todo));
        goals.forEach(goal => addGoalToDom(goal));
      })

      //Hook UI inputs to the store
      function addToDo() {
        const input = document.getElementById('todo');
        const name = input.value;
        input.value = '';

        store.dispatch(addToDoAction({
          name,
          complete: false,
          id: generateId()
        }));
      }

      function addGoal() {
        const input = document.getElementById('goal');
        const name = input.value;
        input.value = '';

        store.dispatch(addGoalAction({
          name,
          id: generateId()
        }));
      }

      document.getElementById('todoButton').addEventListener('click', addToDo);
      document.getElementById('goalButton').addEventListener('click', addGoal);

      function addRemoveButton(removeFunc){
        const removeButton = document.createElement('button');
        removeButton.innerHTML = 'X';
        removeButton.addEventListener('click', removeFunc);
        return removeButton;
      }

      function addToDoToDom(todo) {
        const node = document.createElement('li');
        const text = document.createTextNode(todo.name);
        node.style.textDecoration = todo.complete? 'line-through' : 'none'
        node.appendChild(text)
        node.appendChild(addRemoveButton(() => {
          store.dispatch(removeToDoAction(todo.id));
        }))
        node.addEventListener('click', () => {
          store.dispatch(toggleToDoAction(todo.id))
        });
        document.getElementById('todos').appendChild(node);
      }

      function addGoalToDom(goal) {
        const node = document.createElement('li');
        const text = document.createTextNode(goal.name);
        node.appendChild(text);
        node.appendChild(addRemoveButton(() => {
          store.dispatch(removeGoalAction(goal.id));
        }))
        document.getElementById('goals').appendChild(node);
      }
    </script>
    <script type="text/babel">
      function List (props) {
        return(
          <ul>
            <li>List</li>
          </ul>
        )
      }

      class ToDos extends React.Component {
        addItem = (e) => {
          e.preventDefault();
          const name = this.input.value;
          this.input.value = '';
          this.props.store.dispatch(addToDoAction({
            name,
            complete: false,
            id: generateId()
          }))
        };

        render() {
          return(
            <div>
              <h1>To Do List</h1>
              <input
                type="text"
                placeholder="Add To Do"
                ref={(input) => this.input = input}
                >
              </input>
              <button onClick={this.addItem}>Add To Do</button>
              <List />
            </div>
          )
        }
      }

      class Goals extends React.Component {
        addItem = (e) => {
          e.preventDefault();
          const name = this.input.value;
          this.input.value = '';
          this.props.store.dispatch(addGoalAction({
            name,
            id: generateId()
          }))
        };

        render() {
          return(
            <div>
              <h1>Goals List</h1>
              <input
                type="text"
                placeholder="Add Goal"
                ref={(input) => this.input = input}
                >
              </input>
              <button onClick={this.addItem}>Add Goal</button>
              <List />
            </div>
          )
        }
      }

      class App extends React.Component {
        render() {
          return(
            <div>
              <ToDos store={this.props.store}/>
              <Goals store={this.props.store}/>
            </div>
          )
        }
      }

      ReactDOM.render(
        <App store={store} />,
        document.getElementById('app')
      )
    </script>
  </body>
</html>